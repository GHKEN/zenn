---
title: "react-hook-formのuseFieldArrayでidが上書きされる問題と解決方法"
emoji: "😽"
type: "tech"
topics: ["react", "typescript", "react-hook-form"]
published: false
---

## 問題の概要

react-hook-formの`useFieldArray`を使用する際、配列の要素に`id`プロパティが含まれていると、`useFieldArray`が内部管理用に自動生成する`id`によって上書きされてしまう問題があります。

これは、データベースから取得したデータなど、既に`id`を持つオブジェクトを扱う場合によく遭遇する問題です。

## 問題の詳細

例えば、以下のようなデータ構造を考えます：

```typescript
type User = {
  id: number;
  name: string;
  email: string;
};
```

このデータを`useFieldArray`で管理しようとすると：

```typescript
const { fields } = useFieldArray({
  control,
  name: "users"
});

// fieldsの各要素には、元のidではなく、
// useFieldArrayが生成したuuidのようなidが入っている
```

`fields`配列の各要素を見ると、元のデータの`id: 1`などが`id: "abc123..."`のようなランダムな文字列に置き換わっています。

## なぜこの問題が起きるのか

`useFieldArray`は、Reactのkey管理とフォームの状態管理を効率的に行うため、内部的に一意の`id`を各要素に付与します。この`id`は：

- 配列の要素を一意に識別するため
- 要素の追加・削除・並び替え時に正しくトラッキングするため
- パフォーマンスを最適化するため

に使用されます。しかし、この`id`がユーザーデータの`id`と衝突してしまいます。

## 解決方法

### 方法1: フィールド名を変更する（推奨）

データ構造自体を変更できる場合、`id`以外のフィールド名を使用します：

```typescript
type User = {
  userId: number;  // idからuserIdに変更
  name: string;
  email: string;
};

const { fields } = useFieldArray({
  control,
  name: "users"
});

// fields[0].userId で元のIDにアクセスできる
// fields[0].id はuseFieldArrayが管理するID
```

この方法が最もシンプルで、型アサーションなしで型安全性も保たれます。

### 方法2: keyNameオプションを使用する

`useFieldArray`の`keyName`オプションで、内部管理用のキー名を変更できます：

```typescript
const { fields } = useFieldArray({
  control,
  name: "users",
  keyName: "_id"  // デフォルトの"id"の代わりに"_id"を使用
});

// fields[0].id で元のIDにアクセスできる
// fields[0]._id がuseFieldArrayが管理するID
```

この場合、React要素の`key`プロパティには`_id`を使用します：

```tsx
{fields.map((field, index) => (
  <div key={(field as any)._id}>
    <p>ID: {field.id}</p> {/* 元のidにアクセス可能 */}
    {/* ... */}
  </div>
))}
```

#### 注意：keyNameの将来性について

[公式ドキュメント](https://react-hook-form.com/docs/usefieldarray)によると、`keyName`オプションは次のメジャーバージョンで削除される予定とされています。しかし、現時点で代替策は示されておらず、[GitHub Discussions](https://github.com/orgs/react-hook-form/discussions/8935)でも多数の報告があるものの、明確な解決策は提示されていない状況です。

そのため、長期的なメンテナンスを考慮する場合は、**方法1（フィールド名の変更）を推奨**します。

## まとめ

- `useFieldArray`は内部管理用に`id`を自動生成する
- 元データに`id`がある場合、上書きされてしまう
- 解決方法は主に2つ：
  1. フィールド名を変更する（`userId`など）← 推奨
  2. `keyName`オプションを使用する
- どちらの方法も実用的で、プロジェクトの要件に応じて選択する

この問題を理解しておくことで、react-hook-formをより効果的に使用できます。
